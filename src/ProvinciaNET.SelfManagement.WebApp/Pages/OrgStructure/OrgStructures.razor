@page "/orgstructures"

@attribute [Authorize]
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IOrgStructureService OrgStructureService
@inject IStringLocalizer<LocalizationResource> L

<PageTitle>@L["Structures"]</PageTitle>
<RadzenStack>
    <RadzenRow AlignItems="AlignItems.Center">
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenText Text="@L["Structures"]" TextStyle="TextStyle.H4" TagName="TagName.H1" style="margin: 0" />
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End" Gap="0.5rem">
                <RadzenSplitButton Icon="get_app" Text="@L["Export"]" Click="@ExportClick" Variant="Variant.Flat" Shade="Shade.Lighter">
                    <RadzenSplitButtonItem Text="Excel" Value="xlsx" />
                    <RadzenSplitButtonItem Text="CSV" Value="csv" />
                </RadzenSplitButton>
                <RadzenButton Icon="add_circle_outline" Text="@L["Add"]" Click="@AddButtonClick" Variant="Variant.Flat" />
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>
    <RadzenTextBox Placeholder="@L["Search"]" style="display: block; width: 100%" @oninput="@Search" />
    <RadzenRow>
        <RadzenColumn SizeMD=12>
            <RadzenDataGrid @ref="grid0" Data="@resources" LoadData="@LoadData" TItem="OrgStructure" Density="Density.Compact" 
                            IsLoading="@isLoading" Count="@count" AllowFiltering="true" FilterMode="FilterMode.Advanced" RowDoubleClick="@EditRow"
                            AllowPaging="true" AllowSorting="true" ShowPagingSummary="true" PageSize=@pagesize PageSizeOptions=@(new int[]{5, 10, 20, 30})>
                <Columns>
                    <RadzenDataGridColumn TItem="OrgStructure" Property="Id" Title="Id" Width="70px" />
                    <RadzenDataGridColumn TItem="OrgStructure" Property="Section.Name" Title="@L["Section"]" Width="250" />
                    <RadzenDataGridColumn TItem="OrgStructure" Property="Name" Title="@L["Name"]" Width="250" />
                    <RadzenDataGridColumn TItem="OrgStructure" Property="MailDatabaseGroup.Name" Title="@L["MailDatabaseGroup"]" Width="250" />
                    <RadzenDataGridColumn TItem="OrgStructure" Property="Active" Title="@L["Active"]" Width="100px" />
                    <RadzenDataGridColumn TItem="OrgStructure" Property="CreatedBy" Title="@L["Created By"]" Width="200px" />
                    <RadzenDataGridColumn TItem="OrgStructure" Property="CreatedOn" Title="@L["Created On"]" Width="130px" FormatString="{0:dd/MM/yyy}" />
                    <RadzenDataGridColumn TItem="OrgStructure" Property="ModifiedBy" Title="@L["Modified By"]" Width="200px" />
                    <RadzenDataGridColumn TItem="OrgStructure" Property="ModifiedOn" Title="@L["Modified On"]" Width="130px" FormatString="{0:dd/MM/yyy}" />
                    <RadzenDataGridColumn TItem="OrgStructure" Filterable="false" Sortable="false" Width="70px" TextAlign="TextAlign.Center">
                        <Template Context="resource">
                            <RadzenButton ButtonStyle="ButtonStyle.Danger"
                                          Icon="delete"
                                          Size="ButtonSize.Medium"
                                          Shade="Shade.Lighter"
                                          Variant="Variant.Flat"
                                          Click=@(args => GridDeleteButtonClick(args, resource))
                                          @onclick:stopPropagation="true" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    bool isLoading = false;
    int count = 0;
    int pagesize = 10;
    RadzenDataGrid<OrgStructure>? grid0;
    IEnumerable<OrgStructure>? resources;
    OrgStructure? resource;

    async Task LoadData(string? filter = null, int? top = null, int? skip = null, string? orderby = null)
    {
        var result = await OrgStructureService.GetOdataAsync(filter: filter, top: top, skip: skip, expand: "Section,MailDatabaseGroup", orderby: orderby, count: true);
        resources = result.Value.AsODataEnumerable();
        count = result.Count;
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadData(top: pagesize, skip: 0);
    }

    async Task LoadData(LoadDataArgs args)
    {
        isLoading = true;
        await LoadData(filter: args.Filter, top: args.Top, skip: args.Skip, orderby: args.OrderBy);
        isLoading = false;
    }

    async Task Search(ChangeEventArgs args)
    {
        if (args.Value == null) return;
        var search = args.Value.ToString()!.ToLowerInvariant();

        if (grid0 != null) await grid0.GoToPage(0);
        isLoading = true;
        await LoadData(filter: $"contains(tolower(Name),'{search}')", top: grid0!.PageSize, skip: 0);
        isLoading = false;
    }

    async Task AddButtonClick(MouseEventArgs args)
    {
        await DialogService.OpenAsync<OrgStructureCreate>($"{L["Add"]} {L["Structure"]}", null);
        if (grid0 != null) await grid0.Reload();
    }

    async Task EditRow(DataGridRowMouseEventArgs<OrgStructure> args)
    {
        await DialogService.OpenAsync<OrgStructureUpdate>($"{L["Edit"]} {L["Structure"]}", new Dictionary<string, object> { { "Id", args.Data.Id } });
        if (grid0 != null) await grid0.Reload();
    }

    async Task GridDeleteButtonClick(MouseEventArgs args, OrgStructure resource)
    {
        try
        {
            if (await DialogService.Confirm(L["Delete Confirmation"]) == true)
            {
                await OrgStructureService.DeleteAsync(resource.Id);
                if (grid0 != null) await grid0.Reload();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = $"Error",
                    Detail = $"{L["Unable to delete"]} {@L["Structure"]}. {ex.Message}"
                });
        }
    }

    void ExportClick(RadzenSplitButtonItem args)
    {
        OrgStructureService.ExportToFile(args.Value, "OrgStructures");
    }
}